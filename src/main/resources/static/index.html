<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Spring Boot WebSocket Chat Application</title>
</head>
<body>
<noscript>
    <h2>Sorry! Your browser doesn't support Javascript</h2>
</noscript>

<div>
    <button onclick="connect()">Nhắn 1 người</button>
    <br/>
    <button onclick="connectGroup()">Nhắn trong nhóm</button>
</div>
<br><br>
<div>
    <input type="text" id="message-input" name="message-input" placeholder="Nội dung tin nhắn...">
    <button onclick="sendMessage()">Gửi</button>
    <button onclick="sendMessageGroup()">Gửi nhóm</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const url = "http://localhost:8080";
    var stompClient = null;
    var username = null;

    var senderId = 1;
    var recipientId = 2;

    var colors = [
      '#2196F3', '#32c787', '#00BCD4', '#ff5652',
      '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
    ];

    var messageInput = document.querySelector("#message-input");

    function connect() {
      var socket = new SockJS(url + '/chat');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, onConnected, onError);
    }

    function connectGroup() {
        var socket = new SockJS(url + '/chat');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function() {stompClient.subscribe('/topic/messages/groups/A', onMessageReceived);}, onError);
    }

    function onConnected(frame) {
      // Subscribe to the Public Topic
      console.log("Connected to: " + frame);
      stompClient.subscribe('/topic/messages/' + senderId, onMessageReceived);
    }

    function onError(error) {
      console.log('Could not connect to WebSocket server. Please refresh this page to try again!');
    }

    function sendMessage() {
      var messageContent = messageInput.value.trim();
      if(messageContent && stompClient) {
          var message = {
              type: 'ONLY',
              content: messageContent,
              senderId: senderId,
              recipientId: recipientId
          };
          stompClient.send("/app/messages/chat.sendMessage/" + recipientId, {}, JSON.stringify(message));
          messageInput.value = '';
      }
    }

    function sendMessageGroup() {
      var messageContent = messageInput.value.trim();
      if(messageContent && stompClient) {
          var message = {
              type: 'ONLY',
              content: messageContent,
              senderId: senderId,
              recipientId: 0
          };
          stompClient.send("/app/messages/groups/A", {}, JSON.stringify(message));
          messageInput.value = '';
      }
    }

    function onMessageReceived(payload) {
      var message = JSON.parse(payload.body);
      console.log(message);
    }

    function getAvatarColor(messageSender) {
      var hash = 0;
      for (var i = 0; i < messageSender.length; i++) {
          hash = 31 * hash + messageSender.charCodeAt(i);
      }
      var index = Math.abs(hash % colors.length);
      return colors[index];
    }
</script>
</body>
</html>
